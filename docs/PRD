# üìÑ PRD ‚Äì Sistema Municipal de Licita√ß√µes Eletr√¥nicas (Licitafacil)
**Vers√£o:** 1.3 (Anti-Rob√¥ & Real-Time Control)
**Data:** 23 de outubro de 2025
**Base legal:** Lei n¬∫ 14.133/2021 (Nova Lei de Licita√ß√µes)

---

## 1. Objetivo do Produto
Plataforma SaaS para gest√£o de compras p√∫blicas com foco em **seguran√ßa jur√≠dica, blindagem de identidade** e **controle t√©cnico absoluto**. O sistema deve nascer preparado para alta performance (API-first), mas com restri√ß√µes de automa√ß√£o ativas inicialmente para garantir isonomia.

---

## 2. Atores e Permiss√µes

| Ator | Vis√£o na Fase de Lances | Poderes Especiais |
|------|-------------------------|-------------------|
| **Fornecedor** | V√™ apenas "Licitante X" (An√¥nimo) e seus pr√≥prios lances | Enviar Lances (Humanos apenas - restri√ß√£o ativa) |
| **Pregoeiro** | V√™ apenas "Licitante X" (Blindagem Total) | Gerir Sess√£o, Chat, Avisos, Prorrogar tempo |
| **Monitor T√©cnico** | **V√™ TUDO (CNPJ, Raz√£o Social, IP, Fingerprint)** | **Paralisar/Encerrar Sess√£o (Instant√¢neo)**, Bloquear IP, Auditar |

---

## 3. Funcionalidades Cr√≠ticas e Regras de Neg√≥cio

### 3.1 Monitor T√©cnico em Tempo Real (God Mode) - RF-MON
*Interface de controle de miss√£o cr√≠tica para a equipe de engenharia.*

- **Lat√™ncia Zero:** Deve usar WebSocket/SSE para refletir o estado do banco de dados em tempo real (< 200ms).
- **Controle de P√¢nico (Kill Switch):**
  - O Monitor T√©cnico possui bot√µes de a√ß√£o imediata: **"PARALISAR SESS√ÉO"** e **"ENCERRAR SESS√ÉO"**.
  - **Comportamento:** Ao acionar a paralisa√ß√£o, o backend rejeita imediatamente novos requests de lance (`HTTP 423 Locked`) e congela o cron√¥metro para todos os usu√°rios.
  - **Uso:** Ataques DDoS, falhas de infraestrutura, suspeita grave de fraude ou ordem judicial.
- **Vis√£o de Raio-X:** Tabela detalhada com dados reais (CNPJ, Nome) para auditoria, invis√≠vel aos outros atores.

### 3.2 Pol√≠tica de Automa√ß√£o (Rob√¥s) - RF-BOT

#### Estado Atual (Fase 1 - Inibi√ß√£o)
- **Objetivo:** Inibir o uso de softwares de remessa autom√°tica de lances (rob√¥s) neste momento inicial.
- **Mecanismos de Bloqueio:**
  - **Rate Limiting Humano:** Limitar lances a, por exemplo, 1 lance a cada 3 segundos por token de usu√°rio.
  - **Desafios de Intera√ß√£o:** Implementar verifica√ß√µes se necess√°rio (ex: confirmar slider em lances suspeitos).
  - **Bloqueio por Padr√£o:** Rejeitar rajadas de lances com intervalos de tempo inumanos (ms).

#### Prepara√ß√£o para o Futuro (API First - Ready)
- **Arquitetura:** O backend deve ser constru√≠do **j√° suportando alta concorr√™ncia** (High Frequency Bidding), tratando a inibi√ß√£o apenas como uma camada de valida√ß√£o remov√≠vel.
- **Endpoints Padronizados:** A API de lances (`POST /api/v1/bids`) deve seguir padr√µes RESTful limpos e documentados (Swagger), pronta para ser aberta a integra√ß√µes de terceiros (ERPs de licitantes) no futuro.
- **Feature Flag:** A inibi√ß√£o de rob√¥s deve ser controlada por configura√ß√£o (`ALLOW_EXTERNAL_BOTS = false`). Quando houver consenso futuro, altera-se a flag para `true`, removendo o Rate Limiting restritivo.

### 3.3 Blindagem Total (Double-Blind) - RF-BLIND
- **Anonimato Bilateral:** Nem fornecedores nem o Pregoeiro podem ver a identidade de quem est√° dando lances.
- **Seguran√ßa do Pregoeiro:** O Pregoeiro s√≥ conhece o vencedor na fase de Habilita√ß√£o/Julgamento. Isso protege o pregoeiro de acusa√ß√µes de favorecimento.
- **Chat Anonimizado:** Mensagens no chat aparecem com aliases ("Licitante 142").

### 3.4 Auditoria e Anti-Conluio
- **Fingerprinting:** O sistema coleta o *Device Fingerprint* e IP de quem d√° o lance.
- **Alerta no Monitor T√©cnico:** Se dois CNPJs diferentes derem lances do mesmo *Fingerprint/IP*, o Monitor T√©cnico destaca alerta de **Poss√≠vel Conluio** para a equipe t√©cnica agir.

### 3.5 Integra√ß√£o com ERPs e Legados (RF-INT)
*Funcionalidade para evitar retrabalho dos √≥rg√£os p√∫blicos.*
- **API de Importa√ß√£o:** O sistema deve disponibilizar endpoint `POST /api/v1/import/licitacao` para receber dados estruturados (JSON/XML) de sistemas externos (ex: Betha, IPM, Elotech).
- **Campos de Rastreabilidade:** Toda licita√ß√£o importada deve manter o `codigo_externo` e o `sistema_origem` para facilitar auditoria e sincroniza√ß√£o de status (webhook de volta para o ERP).
- **Valida√ß√£o H√≠brida:** Licita√ß√µes importadas entram como **RASCUNHO** at√© que um usu√°rio humano valide se os dados migrados (datas, valores) est√£o corretos conforme a Lei.

---

## 4. Requisitos N√£o Funcionais
- **Auditabilidade:** Logs imut√°veis de todas as tentativas de lance (inclusive as bloqueadas pelo anti-rob√¥).
- **Performance:** O Core de lances deve suportar milhares de conex√µes simult√¢neas (preparado para o cen√°rio com rob√¥s).
- **Disponibilidade:** SLA de 99.9% durante sess√µes de preg√£o.

---

## 5. Fluxo de Dados (Fase de Lances)

```mermaid
sequenceDiagram
    participant Robo_Fornecedor
    participant Humano_Fornecedor
    participant API_Gateway
    participant Anti_Bot_Guard
    participant Core_Engine
    participant Monitor_Tecnico

    rect rgb(255, 230, 230)
    Note right of Robo_Fornecedor: Cen√°rio Atual (Bloqueio)
    Robo_Fornecedor->>API_Gateway: Rajada de Lances (10/seg)
    API_Gateway->>Anti_Bot_Guard: Verifica Rate Limit
    Anti_Bot_Guard--xRobo_Fornecedor: HTTP 429 (Too Many Requests)
    end

    rect rgb(230, 255, 230)
    Note right of Humano_Fornecedor: Lance V√°lido
    Humano_Fornecedor->>API_Gateway: Lance Manual
    API_Gateway->>Anti_Bot_Guard: Verifica Rate Limit (OK)
    Anti_Bot_Guard->>Core_Engine: Processa Lance
    Core_Engine->>Monitor_Tecnico: PUSH Real-Time (Dados Reais)
    end
```

---

## 6. Stack Tecnol√≥gica e Padr√µes (RF-TECH)

### 6.1 Backend (A Espinha Dorsal)
- **Linguagem:** TypeScript (Node.js).
- **Framework:** **NestJS**.
  - *Motivo:* Padr√£o corporativo r√≠gido (Arquitetura Modular, Inje√ß√£o de Depend√™ncia), facilitando manuten√ß√£o e escalabilidade.
- **Database:** **PostgreSQL**.
  - *Uso:* Dados relacionais cr√≠ticos (Licita√ß√µes, Usu√°rios, Logs de Auditoria).
- **Cache/PubSub:** **Redis**.
  - *Uso:* Gerenciamento de filas de lances e comunica√ß√£o real-time (Socket.io).

### 6.2 Frontend (A Experi√™ncia)
- **Framework:** **Next.js (React)**.
  - *Motivo:* Performance h√≠brida (SSR para Portal da Transpar√™ncia, CSR para Sala de Disputa).
- **Design System:** **Shadcn/UI + TailwindCSS**.
  - *Estilo:* **"Clean Corporate"**. Foco em legibilidade, alto contraste e tabelas densas de informa√ß√£o com baixa polui√ß√£o visual.
  - *Simplicidade:* Interfaces minimalistas. O Pregoeiro deve ver apenas o bot√£o que ele precisa clicar naquele momento.

### 6.3 Infraestrutura e DevOps
- **Containeriza√ß√£o:** Docker (obrigat√≥rio para ambientes de desenvolvimento e produ√ß√£o).
- **CI/CD:** Pipelines automatizados para testes unit√°rios antes do deploy.
